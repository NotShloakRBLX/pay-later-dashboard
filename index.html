<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="theme-color" content="#0b0f14" />
<title>BNPL — Mobile Dashboard</title>
<style>
  :root{
    --bg:#0b0f14; --surface:#101722; --card:#121a27; --ink:#e9eef7; --muted:#a8b3c7;
    --brand:#5b8cff; --brand2:#8a7dff; --ok:#2fd39b; --warn:#ffcc66; --danger:#ff6b6b;
    --outline:#263247; --glass:rgba(255,255,255,.06); --radius:16px; --t:.22s cubic-bezier(.2,.8,.2,1);
    color-scheme:dark;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 600px at 80% -20%, rgba(91,140,255,.35), transparent 60%),
      radial-gradient(900px 500px at -10% 10%, rgba(138,125,255,.30), transparent 60%),
      var(--bg);
    color:var(--ink);
    font: 16px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    min-height: 100dvh;
    padding-top: env(safe-area-inset-top);
    padding-bottom: calc(env(safe-area-inset-bottom) + 72px); /* room for bottom bar */
    overflow-x:hidden;
    touch-action: manipulation;
  }
  @media (prefers-reduced-motion: reduce){
    *{animation:none!important; transition:none!important}
  }

  /* Header */
  header{
    position: sticky; top: 0; z-index: 50;
    background: linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.75));
    backdrop-filter: blur(10px);
    padding: max(10px, env(safe-area-inset-top)) 14px 10px;
    border-bottom: 1px solid var(--outline);
    display:flex; gap:10px; align-items:center;
  }
  .logo{
    width:40px;height:40px;border-radius:12px;
    background:linear-gradient(135deg,var(--brand),var(--brand2));
    display:grid;place-items:center; flex:0 0 auto;
  }
  .logo svg{width:22px;height:22px; fill:#fff}
  .tit h1{margin:0;font-size:18px; letter-spacing:.2px}
  .tit p{margin:2px 0 0; color:var(--muted); font-size:12px}

  /* Content */
  .wrap{padding: 10px 14px 14px; display:grid; gap:12px}
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid var(--outline); border-radius: var(--radius); padding:14px;
  }
  .card h3{margin:0 0 10px; font-size:12px; color:var(--muted); letter-spacing:.3px; text-transform:uppercase}
  .big{display:flex; align-items:baseline; gap:8px; font-size:28px; font-weight:800}
  .sub{color:var(--muted); font-size:13px}
  .progress{height:10px;border-radius:999px;background:#0f1622;border:1px solid #213047; overflow:hidden}
  .progress > span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--brand2)); transition:width var(--t)}
  #paydownSub{margin-top:10px} /* moved slightly lower */

  /* Plans list — less cramped */
  .list{display:grid; gap:12px}
  .row{
    display:grid; gap:12px; grid-template-columns: 1fr auto; align-items:center;
    padding:14px; border:1px solid var(--outline); border-radius:12px; background:var(--surface);
  }
  .row .left{display:flex; gap:12px; align-items:flex-start; min-width:0}
  .logo-sm{flex:0 0 auto;width:36px;height:36px;border-radius:9px;display:grid;place-items:center}
  .logo-sm[data-merchant^="A"]{background:#232b3a;color:#9ecbff}
  .logo-sm[data-merchant^="S"]{background:#272235;color:#d3c8ff}
  .logo-sm[data-merchant^="N"]{background:#233628;color:#98f0c8}
  .logo-sm[data-merchant^="T"]{background:#2b2620;color:#ffd39f}
  .title{min-width:0}
  .title b{display:block; font-size:15px; white-space:normal; word-break:break-word}
  .title .sub{margin-top:2px}
  .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--outline); background:var(--glass); color:var(--muted)}
  .right{display:flex; gap:8px; flex-direction:column; align-items:flex-end}

  .btn{
    appearance:none; border:1px solid transparent; border-radius:12px; font-weight:700;
    padding:10px 12px; background:linear-gradient(135deg,var(--brand),var(--brand2));
    color:#fff; box-shadow:0 6px 18px rgba(91,140,255,.3);
    transition:transform var(--t), filter var(--t), opacity var(--t);
    min-width:88px; text-align:center;
  }
  .btn:active{transform:translateY(1px)}
  .ghost{background:transparent; border-color:var(--outline); color:#e8eef9; box-shadow:none}

  /* Fullscreen mobile modal */
  dialog{
    border:none; padding:0; width:100vw; max-width:100vw; height:100dvh; max-height:100dvh;
    background:var(--card); color:var(--ink);
  }
  dialog::backdrop{background: rgba(5,9,14,.6); backdrop-filter: blur(6px)}
  .sheet{display:grid; grid-template-rows: auto 1fr; height:100%}

  /* Smooth slide/fade for dialogs */
  .dialog-anim{opacity:0; transform: translateY(16px); transition: opacity var(--t), transform var(--t)}
  .dialog-anim.open{opacity:1; transform:none}
  .dialog-anim.closing{opacity:0; transform: translateY(16px)}

  .m-head{
    position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(18,26,39,.98), rgba(18,26,39,.9));
    border-bottom:1px solid var(--outline);
    padding: max(10px, env(safe-area-inset-top)) 14px 10px;
    display:flex; gap:10px; align-items:center;
  }
  .m-head h2{margin:0; font-size:18px}
  .m-body{overflow:auto; -webkit-overflow-scrolling:touch; padding: 12px 14px 120px; display:grid; gap:12px}
  .field{display:grid; gap:6px}
  .field label{font-size:12px; color:var(--muted)}
  input, button, select{font-size:16px}
  input[type="number"], input[type="text"]{width:100%; padding:12px; border-radius:12px; border:1px solid var(--outline); background:#0f1624; color:#fff}
  input[type="range"]{width:100%}
  .seg{display:flex; border:1px solid var(--outline); border-radius:12px; overflow:hidden}
  .seg button{flex:1; padding:12px; background:transparent; border:none; color:var(--ink); font-weight:700}
  .seg button[aria-pressed="true"]{background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff}
  .grid2{display:grid; gap:10px}
  .row2{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; padding:10px 0; border-bottom:1px solid var(--outline)}
  .row2:last-child{border-bottom:none}
  .badge{font-size:12px; padding:2px 6px; border-radius:999px; border:1px solid var(--outline); color:var(--muted)}
  .badge.paid{background:rgba(47,211,155,.12); border-color: rgba(47,211,155,.35); color: var(--ok)}
  .total{font-weight:800; font-size:18px}

  /* Bottom action bar — centered single button */
  .bottom{
    position: fixed; left:0; right:0; bottom:0; z-index:60;
    padding: 10px 14px calc(10px + env(safe-area-inset-bottom));
    background: linear-gradient(180deg, rgba(11,15,20,0), rgba(11,15,20,.9) 20%, rgba(11,15,20,.98) 60%);
    border-top:1px solid var(--outline);
    display:flex; justify-content:center;
  }
  #newPlan{min-width: 240px}

  /* Mobile-only blocker on wide screens */
  .desktop-blocker{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; text-align:center;
    background:#0b0f14; color:#fff; padding:40px; z-index:1000;
  }
  .desktop-blocker p{color:#c3cee3}
  @media (min-width: 820px){
    .desktop-blocker{display:flex}
  }

  .hint{font-size:12px; color:#97a5bd}
  .hr{height:1px; background:var(--outline); margin: 2px 0 0}
  .empty{padding:20px; border:1px dashed var(--outline); border-radius:12px; color:#c3cee3; text-align:center}
  .link{color:#cfe0ff; text-decoration:none; border-bottom:1px dotted #cfe0ff}
</style>
</head>
<body>
  <div class="desktop-blocker">
    <div>
      <h1>Mobile Only</h1>
      <p>This dashboard is optimized for phones. Open on a mobile device or use your browser’s mobile preview (≤819px).</p>
    </div>
  </div>

  <header>
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M12 2c5.5 0 10 4.5 10 10v2.4c0 1.8-1.4 3.2-3.2 3.2H16a2 2 0 0 1-2-2v-1.5a2.5 2.5 0 1 0-4.9 0V19a3 3 0 0 1-3 3H5.2A3.2 3.2 0 0 1 2 18.8V12C2 6.5 6.5 2 12 2z" fill="#fff"/></svg>
    </div>
    <div class="tit">
      <h1>BNPL — Dashboard</h1>
      <p>Track plans, pay, manage autopay</p>
    </div>
  </header>

  <main class="wrap" id="app">
    <section class="card">
      <h3>Present Balance</h3>
      <div class="big"><span id="presentBalance">$0.00</span></div>
      <div class="sub">Total remaining across active plans</div>
      <div style="height:10px"></div>
      <div class="progress" aria-label="Paydown progress"><span id="paydownBar"></span></div>
      <div class="sub" id="paydownSub">0% paid</div>
    </section>

    <section class="card">
      <h3>Upcoming Payment</h3>
      <div class="big"><span id="nextAmount">$0.00</span></div>
      <div class="sub">Due <span id="nextDate">—</span></div>
      <div style="height:10px"></div>
      <button class="btn" id="payNextBtn" style="width:100%">Pay next due</button>
      <div class="hint" style="margin-top:8px">Tip: Early payments may increase your limit.</div>
    </section>

    <section class="card">
      <h3>Active Plans</h3>
      <div id="plansList" class="list"></div>
      <div id="emptyState" class="empty" hidden>No active plans. Tap <b>New plan</b> to add a demo loan.</div>
    </section>
  </main>

  <!-- Bottom action bar (only New plan) -->
  <div class="bottom">
    <button class="btn" id="newPlan">New plan</button>
  </div>

  <!-- PLAN MODAL: Schedule & Settings FIRST; Make a Payment button below -->
  <dialog id="planModal">
    <div class="sheet dialog-anim" id="planAnim">
      <div class="m-head">
        <div class="logo-sm" id="pmLogo" data-merchant="A" aria-hidden="true" style="width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:#232b3a">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="#cfe0ff"><circle cx="12" cy="12" r="8"/></svg>
        </div>
        <div style="flex:1">
          <h2 id="pmTitle" style="margin:0">Manage Plan</h2>
          <div class="sub" id="pmSubtitle">—</div>
        </div>
        <button class="btn ghost" id="closePlan" style="min-width:64px">Close</button>
      </div>

      <div class="m-body">
        <section class="card">
          <h3>Schedule & Settings</h3>
          <div class="row2" style="border:none"><div>Remaining</div><div id="pmRemaining"><b>$0.00</b></div></div>
          <div class="row2" style="border:none"><div>Next due</div><div id="pmNextDue">—</div></div>
          <div class="hr"></div>
          <div id="pmSchedule"></div>
        </section>

        <div style="display:flex;justify-content:center">
          <button class="btn" id="openPay">Make a payment</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- PAY MODAL: standalone "Make a Payment" pop-up -->
  <dialog id="payModal">
    <div class="sheet dialog-anim" id="payAnim">
      <div class="m-head">
        <div style="flex:1">
          <h2 id="payTitle" style="margin:0">Make a Payment</h2>
          <div class="sub" id="paySubtitle">—</div>
        </div>
        <button class="btn ghost" id="closePay" style="min-width:64px">Close</button>
      </div>

      <div class="m-body">
        <section class="card">
          <h3>Make a Payment</h3>
          <div class="field">
            <label>Amount</label>
            <input id="payAmountInput" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" />
            <input id="payAmountRange" type="range" min="0" max="0" value="0" />
            <div class="hint">Drag the slider or enter a custom amount.</div>
          </div>

          <div class="field">
            <label>Speed</label>
            <div class="seg" role="tablist" aria-label="Payment speed">
              <button type="button" id="paySpeedStandard" aria-pressed="true">1–2 business days (free)</button>
              <button type="button" id="paySpeedInstant" aria-pressed="false">Instant (fee)</button>
            </div>
            <div class="hint">Arrives by <span id="payArrivalEta">—</span></div>
          </div>

          <div class="field">
            <label>Summary</label>
            <div class="row2" style="border:none"><div>Payment</div><div id="paySumPayment"><b>$0.00</b></div></div>
            <div class="row2" style="border:none"><div>Instant fee</div><div id="paySumFee">$0.00</div></div>
            <div class="hr"></div>
            <div class="row2" style="border:none"><div class="total">Total today</div><div id="paySumTotal" class="total">$0.00</div></div>
          </div>

          <div class="grid2">
            <button class="btn ghost" id="payPayMin">Pay minimum</button>
            <button class="btn" id="payConfirm">Confirm & Pay</button>
          </div>
          <div class="hint">Demo only — no real money moves.</div>
        </section>
      </div>
    </div>
  </dialog>

<script>
(function(){
  const $ = (q, el=document)=> el.querySelector(q);
  const fmtMoney = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'});
  const fmtDate = (d)=> new Date(d).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});
  const addDays = (d, n)=> { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
  const cap = (v,min,max)=> Math.max(min, Math.min(max, v));
  const LS_KEY = 'bnpl_mobile_demo_v1';

  let state = load() || seed();
  let currentPlan = null; // active plan in modals

  function load(){ try { return JSON.parse(localStorage.getItem(LS_KEY)||''); } catch { return null; } }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  function seed(){
    const today = new Date();
    const mk = (id, merchant, total, n, first=5)=>{
      const per = +(total/n).toFixed(2);
      const schedule = Array.from({length:n}, (_,i)=>({
        idx:i+1,
        amount: i===n-1 ? +(total - per*(n-1)).toFixed(2) : per,
        due: addDays(today, first + 14*i).toISOString(),
        paid:false, paidAt:null
      }));
      return {id, merchant, total, remaining: total, installments:n, schedule, created: today.toISOString()};
    };
    return {plans:[ mk(1,'Amazon',324.97,4,5), mk(2,'Target',128.40,4,3), mk(3,'Nike',219.00,3,9), mk(4,'Spotify',59.97,3,6) ], limit:1500, reserved:0, rewards:8.25};
  }

  // Elements
  const els = {
    presentBalance: $('#presentBalance'), paydownBar: $('#paydownBar'), paydownSub: $('#paydownSub'),
    nextAmount: $('#nextAmount'), nextDate: $('#nextDate'), payNextBtn: $('#payNextBtn'),
    plansList: $('#plansList'), emptyState: $('#emptyState'),
    newPlan: $('#newPlan'),
  };

  function compute(){
    const presentBalance = state.plans.reduce((a,p)=> a + p.remaining, 0);
    const paid = state.plans.reduce((a,p)=> a + (p.total - p.remaining), 0);
    const total = state.plans.reduce((a,p)=> a + p.total, 0);
    const pct = total ? Math.round((paid/total)*100) : 0;
    const up = [];
    state.plans.forEach(p=>{
      const nxt = p.schedule.find(s=>!s.paid);
      if(nxt) up.push({plan:p, ...nxt});
    });
    up.sort((a,b)=> new Date(a.due)-new Date(b.due));
    const nextDue = up[0] || null;
    return {presentBalance, pct, nextDue};
  }

  function render(){
    const {presentBalance, pct, nextDue} = compute();
    els.presentBalance.textContent = fmtMoney.format(presentBalance);
    els.paydownBar.style.width = pct + '%';
    els.paydownSub.textContent = pct + '% paid';

    if(nextDue){
      els.nextAmount.textContent = fmtMoney.format(nextDue.amount);
      els.nextDate.textContent = fmtDate(nextDue.due);
      els.payNextBtn.disabled = false;
      els.payNextBtn.onclick = ()=> openPlanModal(nextDue.plan.id, nextDue.amount);
    }else{
      els.nextAmount.textContent = '$0.00';
      els.nextDate.textContent = '—';
      els.payNextBtn.disabled = true;
    }

    renderPlans();
  }

  function renderPlans(){
    const L = state.plans;
    els.plansList.innerHTML = '';
    els.emptyState.hidden = L.length>0;

    L.forEach(p=>{
      const next = p.schedule.find(s=>!s.paid);
      const paid = p.total - p.remaining;
      const pct = p.total? Math.round(paid/p.total*100):0;

      const row = document.createElement('div');
      row.className = 'row';

      const left = document.createElement('div');
      left.className = 'left';

      const logo = document.createElement('div');
      logo.className = 'logo-sm';
      logo.dataset.merchant = p.merchant[0].toUpperCase();
      logo.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#cfe0ff"><circle cx="12" cy="12" r="8"/></svg>`;

      const ttl = document.createElement('div');
      ttl.className = 'title';
      ttl.innerHTML = `<b>${p.merchant}</b>
        <div class="sub">Plan ${p.installments} • ${fmtMoney.format(p.total)}</div>
        <div style="margin-top:8px" class="progress" aria-label="Installment progress"><span style="width:${pct}%"></span></div>
        <div class="sub" style="margin-top:6px">${fmtMoney.format(Math.max(0, paid))} paid • ${pct}%</div>`;

      left.append(logo, ttl);

      const right = document.createElement('div');
      right.className = 'right';
      const due = document.createElement('div');
      due.innerHTML = next ? `<span class="pill">Due ${fmtDate(next.due)}</span>` : `<span class="pill">Paid off</span>`;
      const manage = document.createElement('button');
      manage.className = 'btn'; manage.textContent = 'Manage';
      manage.onclick = ()=> openPlanModal(p.id, next? next.amount : 0);

      right.append(due, manage);

      row.append(left, right);
      els.plansList.append(row);
    });
  }

  /* ---------- Smooth dialog helpers ---------- */
  function openDialog(dlg, animEl){
    if(dlg.showModal) dlg.showModal(); else dlg.setAttribute('open','open');
    // next frame -> add .open to animate
    requestAnimationFrame(()=> animEl.classList.add('open'));
  }
  function closeDialog(dlg, animEl){
    animEl.classList.add('closing');
    animEl.classList.remove('open');
    animEl.addEventListener('transitionend', function onEnd(){
      animEl.removeEventListener('transitionend', onEnd);
      animEl.classList.remove('closing');
      if(dlg.close) dlg.close(); else dlg.removeAttribute('open');
    });
  }

  /* ---------- PLAN MODAL (schedule-first) ---------- */
  const planDlg = $('#planModal'), planAnim = $('#planAnim');
  const pl = {
    title: $('#pmTitle'), subtitle: $('#pmSubtitle'), logo: $('#pmLogo'),
    rem: $('#pmRemaining'), next: $('#pmNextDue'), sched: $('#pmSchedule'),
    openPay: $('#openPay'), close: $('#closePlan')
  };

  function openPlanModal(id, suggested=0){
    currentPlan = state.plans.find(p=>p.id===id);
    if(!currentPlan) return;

    pl.title.textContent = `${currentPlan.merchant} — Plan`;
    pl.subtitle.textContent = `${currentPlan.installments} installments • ${fmtMoney.format(currentPlan.total)}`;
    pl.logo.dataset.merchant = currentPlan.merchant[0].toUpperCase();
    pl.rem.innerHTML = `<b>${fmtMoney.format(currentPlan.remaining)}</b>`;
    const next = currentPlan.schedule.find(s=>!s.paid);
    pl.next.textContent = next? `${fmtDate(next.due)} • ${fmtMoney.format(next.amount)}` : 'Paid off';

    // schedule
    pl.sched.innerHTML = '';
    currentPlan.schedule.forEach(s=>{
      const r = document.createElement('div'); r.className='row2';
      r.innerHTML = `<div>#${s.idx} • ${fmtDate(s.due)} ${s.paid? '<span class="badge paid" style="margin-left:6px">Paid</span>' : ''}</div>
                     <div><b>${fmtMoney.format(s.amount)}</b></div>`;
      pl.sched.append(r);
    });

    pl.openPay.onclick = ()=> openPayModal(currentPlan.id, next? next.amount : 0);
    pl.close.onclick = ()=> closeDialog(planDlg, planAnim);

    openDialog(planDlg, planAnim);
  }

  /* ---------- PAY MODAL (standalone) ---------- */
  const payDlg = $('#payModal'), payAnim = $('#payAnim');
  const pay = {
    title: $('#payTitle'), subtitle: $('#paySubtitle'),
    range: $('#payAmountRange'), amount: $('#payAmountInput'),
    speedStd: $('#paySpeedStandard'), speedInst: $('#paySpeedInstant'),
    eta: $('#payArrivalEta'),
    sumPay: $('#paySumPayment'), sumFee: $('#paySumFee'), sumTotal: $('#paySumTotal'),
    payMin: $('#payPayMin'), confirm: $('#payConfirm'), close: $('#closePay'),
  };
  let speed = 'standard';

  function openPayModal(id, suggested=0){
    currentPlan = state.plans.find(p=>p.id===id);
    if(!currentPlan) return;

    pay.title.textContent = `Make a Payment`;
    pay.subtitle.textContent = `${currentPlan.merchant} • ${currentPlan.installments} installments • ${fmtMoney.format(currentPlan.total)}`;

    // amount
    const max = +currentPlan.remaining.toFixed(2);
    pay.range.max = String(max);
    const start = suggested ? cap(suggested,0,max) : Math.min((currentPlan.schedule.find(s=>!s.paid)?.amount)||0, max);
    pay.range.value = String(start);
    pay.amount.value = (+pay.range.value || 0).toFixed(2);

    speed = 'standard';
    pay.speedStd.setAttribute('aria-pressed','true');
    pay.speedInst.setAttribute('aria-pressed','false');
    updatePaySummary();

    pay.close.onclick = ()=> closeDialog(payDlg, payAnim);
    openDialog(payDlg, payAnim);
  }

  function updatePaySummary(){
    const max = parseFloat(pay.range.max||'0');
    const val = cap(parseFloat(pay.amount.value||'0'), 0, max);
    pay.amount.value = isFinite(val) ? val.toFixed(2) : '0.00';
    pay.range.value = String(val);

    const fee = speed==='instant' ? +(Math.min(val*0.015, 5).toFixed(2)) : 0;
    const total = +(val + fee).toFixed(2);
    pay.sumPay.innerHTML = `<b>${fmtMoney.format(val)}</b>`;
    pay.sumFee.textContent = fmtMoney.format(fee);
    pay.sumTotal.textContent = fmtMoney.format(total);

    // Arrival ETA
    const base = new Date();
    if(speed==='instant'){
      const eta = new Date(base.getTime()+ 5*60*1000);
      pay.eta.textContent = eta.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
    }else{
      let d = new Date(base), added=0;
      while(added<2){ d.setDate(d.getDate()+1); const day=d.getDay(); if(day!==0 && day!==6) added++; }
      pay.eta.textContent = fmtDate(d);
    }
  }

  pay.range.addEventListener('input', ()=>{ pay.amount.value = (+pay.range.value).toFixed(2); updatePaySummary(); });
  pay.amount.addEventListener('input', updatePaySummary);
  pay.speedStd.addEventListener('click', ()=>{ speed='standard'; pay.speedStd.setAttribute('aria-pressed','true'); pay.speedInst.setAttribute('aria-pressed','false'); updatePaySummary(); });
  pay.speedInst.addEventListener('click', ()=>{ speed='instant'; pay.speedStd.setAttribute('aria-pressed','false'); pay.speedInst.setAttribute('aria-pressed','true'); updatePaySummary(); });
  pay.payMin.addEventListener('click', ()=>{
    const next = currentPlan?.schedule.find(s=>!s.paid);
    const target = next ? next.amount : 0;
    pay.range.value = String(target);
    pay.amount.value = target.toFixed(2);
    updatePaySummary();
  });
  pay.confirm.addEventListener('click', ()=>{
    const val = parseFloat(pay.amount.value||'0');
    if(!currentPlan || !val || val<=0) return;

    // Apply payment oldest-first
    let remaining = val;
    for(const s of currentPlan.schedule){
      if(remaining<=0) break;
      if(s.paid) continue;
      const payAmt = Math.min(remaining, s.amount);
      s.amount = +(s.amount - payAmt).toFixed(2);
      remaining = +(remaining - payAmt).toFixed(2);
      if(s.amount <= 0.009){ s.paid = true; s.paidAt = new Date().toISOString(); s.amount = 0; }
    }
    currentPlan.remaining = currentPlan.schedule.filter(s=>!s.paid).reduce((a,s)=> a + s.amount, 0);
    state.rewards = +((state.rewards||0) + Math.min(val*0.01, 1.50)).toFixed(2);

    save();
    render();

    // close Pay, reopen/refresh Plan with smooth transitions
    closeDialog(payDlg, payAnim);
    setTimeout(()=> openPlanModal(currentPlan.id), 180);
  });

  /* Toolbar: Add new plan */
  els.newPlan.addEventListener('click', ()=>{
    const m = prompt('Merchant name? (e.g., Apple)') || 'Sample Store';
    const total = parseFloat(prompt('Total amount? (e.g., 199.99)')||'199.99');
    const n = parseInt(prompt('Number of installments? (e.g., 4)')||'4',10);
    if(!isFinite(total)||!isFinite(n)|| total<=0 || n<=0) return alert('Invalid values.');
    const id = (state.plans.reduce((mx,p)=> Math.max(mx,p.id),0)+1) || 1;
    const today = new Date();
    const per = +(total/n).toFixed(2);
    const sched = Array.from({length:n},(_,i)=>({idx:i+1, amount: i===n-1? +(total - per*(n-1)).toFixed(2):per, due: addDays(today, 7+14*i).toISOString(), paid:false, paidAt:null}));
    state.plans.push({id, merchant:m, total, remaining: total, installments:n, schedule:sched, created: today.toISOString()});
    save(); render();
  });

  // Pay next quick button (kept)
  els.payNextBtn.addEventListener('click', ()=>{
    const up = compute().nextDue;
    if(up) openPlanModal(up.plan.id, up.amount);
  });

  render();
})();
</script>
</body>
</html>
