<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="theme-color" content="#0b0f14" />
<title>BNPL — Mobile Dashboard</title>
<style>
  :root{
    --bg:#0b0f14; --surface:#101722; --card:#121a27; --ink:#e9eef7; --muted:#a8b3c7;
    --brand:#5b8cff; --brand2:#8a7dff; --ok:#2fd39b; --warn:#ffcc66; --danger:#ff6b6b;
    --outline:#263247; --glass:rgba(255,255,255,.06); --radius:16px; --t:.22s cubic-bezier(.2,.8,.2,1);
    color-scheme:dark;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;
    background: var(--bg);
    color:var(--ink);
    font: 16px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    min-height: 100dvh;
    padding-top: env(safe-area-inset-top);
    padding-bottom: calc(env(safe-area-inset-bottom) + 72px);
    overflow-x:hidden;
    touch-action: manipulation;
  }
  @media (prefers-reduced-motion: reduce){ *{animation:none!important; transition:none!important} }

  header{
    position: sticky; top: 0; z-index: 50;
    background: linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.75));
    backdrop-filter: blur(10px);
    padding: max(10px, env(safe-area-inset-top)) 14px 10px;
    border-bottom: 1px solid var(--outline);
    display:flex; gap:10px; align-items:center;
  }
  .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;flex:0 0 auto}
  .logo svg{width:22px;height:22px; fill:#fff}
  .tit h1{margin:0;font-size:18px; letter-spacing:.2px}
  .tit p{margin:2px 0 0; color:var(--muted); font-size:12px}

  .wrap{padding: 10px 14px 14px; display:grid; gap:12px}
  .card{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--outline); border-radius: var(--radius); padding:14px}
  .card h3{margin:0 0 10px; font-size:12px; color:var(--muted); letter-spacing:.3px; text-transform:uppercase}
  .big{display:flex; align-items:baseline; gap:8px; font-size:28px; font-weight:800}
  .sub{color:var(--muted); font-size:13px}
  .progress{height:10px;border-radius:999px;background:#0f1622;border:1px solid #213047; overflow:hidden}
  .progress > span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--brand2)); transition:width var(--t)}
  #paydownSub{margin-top:10px}

  .list{display:grid; gap:12px}
  .row{display:grid; gap:12px; grid-template-columns: 1fr auto; align-items:center; padding:14px; border:1px solid var(--outline); border-radius:12px; background:var(--surface)}
  .row .left{display:flex; gap:12px; align-items:flex-start; min-width:0}
  .logo-sm{flex:0 0 auto;width:36px;height:36px;border-radius:9px;display:grid;place-items:center}
  .logo-sm[data-merchant^="A"]{background:#232b3a;color:#9ecbff}
  .logo-sm[data-merchant^="S"]{background:#272235;color:#d3c8ff}
  .logo-sm[data-merchant^="N"]{background:#233628;color:#98f0c8}
  .logo-sm[data-merchant^="T"]{background:#2b2620;color:#ffd39f}
  .title{min-width:0}
  .title b{display:block; font-size:15px; white-space:normal; word-break:break-word}
  .title .sub{margin-top:2px}
  .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--outline); background:var(--glass); color:var(--muted)}
  .right{display:flex; gap:8px; flex-direction:column; align-items:flex-end}

  .btn{appearance:none; border:1px solid transparent; border-radius:12px; font-weight:700; padding:10px 12px; background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff; box-shadow:0 6px 18px rgba(91,140,255,.3); transition:transform var(--t), filter var(--t), opacity var(--t); min-width:88px; text-align:center}
  .btn:active{transform:translateY(1px)}
  .ghost{background:transparent; border-color:var(--outline); color:#e8eef9; box-shadow:none}
  .btn[disabled]{opacity:.6; filter:saturate(.7)}

  dialog{border:none; padding:0; width:100vw; max-width:100vw; height:100dvh; max-height:100dvh; background:var(--card); color:var(--ink)}
  dialog::backdrop{background: rgba(5,9,14,.6); backdrop-filter: blur(6px)}
  .sheet{display:grid; grid-template-rows: auto 1fr; height:100%}
  .dialog-anim{opacity:0; transform: translateY(16px); transition: opacity var(--t), transform var(--t)}
  .dialog-anim.open{opacity:1; transform:none}
  .dialog-anim.closing{opacity:0; transform: translateY(16px)}
  .m-head{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(18,26,39,.98), rgba(18,26,39,.9)); border-bottom:1px solid var(--outline); padding: max(10px, env(safe-area-inset-top)) 14px 10px; display:flex; gap:10px; align-items:center}
  .m-head h2{margin:0; font-size:18px}
  .m-body{overflow:auto; -webkit-overflow-scrolling:touch; padding: 12px 14px 120px; display:grid; gap:12px}
  .field{display:grid; gap:6px}
  .field label{font-size:12px; color:var(--muted)}
  input[type="number"]{width:100%; padding:12px; border-radius:12px; border:1px solid var(--outline); background:#0f1624; color:#fff}

  .bottom{position: fixed; left:0; right:0; bottom:0; z-index:60; padding: 10px 14px calc(10px + env(safe-area-inset-bottom)); background: linear-gradient(180deg, rgba(11,15,20,0), rgba(11,15,20,.9) 20%, rgba(11,15,20,.98) 60%); border-top:1px solid var(--outline); display:flex; justify-content:center}
  #newPlan{min-width: 240px}

  .desktop-blocker{position:fixed; inset:0; display:none; align-items:center; justify-content:center; text-align:center; background:#0b0f14; color:#fff; padding:40px; z-index:1000}
  .desktop-blocker p{color:#c3cee3}
  @media (min-width: 820px){ .desktop-blocker{display:flex} }

  .hint{font-size:12px; color:#97a5bd}
  .hr{height:1px; background:var(--outline); margin: 2px 0 0}
  .empty{padding:20px; border:1px dashed var(--outline); border-radius:12px; color:#c3cee3; text-align:center}
  .link{color:#cfe0ff; text-decoration:none; border-bottom:1px dotted #cfe0ff}

  /* Plan type options */
  .opt{display:grid; gap:6px; padding:14px; border:1px solid var(--outline); border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); text-align:left}
  .opt h4{margin:0; font-size:16px}
  .opt small{color:var(--muted)}
  .opt[aria-pressed="true"]{outline:2px solid var(--brand); box-shadow:0 6px 18px rgba(91,140,255,.25)}
</style>
</head>
<body>
  <div class="desktop-blocker">
    <div>
      <h1>Mobile Only</h1>
      <p>This dashboard is optimized for phones. Open on a mobile device or use your browser’s mobile preview (≤819px).</p>
    </div>
  </div>

  <header>
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M12 2c5.5 0 10 4.5 10 10v2.4c0 1.8-1.4 3.2-3.2 3.2H16a2 2 0 0 1-2-2v-1.5a2.5 2.5 0 1 0-4.9 0V19a3 3 0 0 1-3 3H5.2A3.2 3.2 0 0 1 2 18.8V12C2 6.5 6.5 2 12 2z" fill="#fff"/></svg>
    </div>
    <div class="tit">
      <h1>BNPL — Dashboard</h1>
      <p>Track plans, pay, manage autopay</p>
    </div>
  </header>

  <main class="wrap" id="app">
    <section class="card">
      <h3>Present Balance</h3>
      <div class="big"><span id="presentBalance">$0.00</span></div>
      <div class="sub">Total remaining across active plans</div>
      <div style="height:10px"></div>
      <div class="progress" aria-label="Paydown progress"><span id="paydownBar"></span></div>
      <div class="sub" id="paydownSub">0% paid</div>
    </section>

    <section class="card">
      <h3>Upcoming Payment</h3>
      <div class="big"><span id="nextAmount">$0.00</span></div>
      <div class="sub">Due <span id="nextDate">—</span></div>
      <div style="height:10px"></div>
      <button class="btn" id="payNextBtn" style="width:100%">Pay next due</button>
      <div class="hint" style="margin-top:8px">Tip: Early payments may increase your limit.</div>
    </section>

    <section class="card">
      <h3>Active Plans</h3>
      <div id="plansList" class="list"></div>
      <div id="emptyState" class="empty" hidden>No active plans. Tap <b>New plan</b> to add a demo loan.</div>
    </section>
  </main>

  <div class="bottom">
    <button class="btn" id="newPlan">New plan</button>
  </div>

  <!-- Manage + Pay modals (unchanged from previous step) -->
  <dialog id="planModal">
    <div class="sheet dialog-anim" id="planAnim">
      <div class="m-head">
        <div class="logo-sm" id="pmLogo" data-merchant="A" aria-hidden="true" style="width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:#232b3a">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="#cfe0ff"><circle cx="12" cy="12" r="8"/></svg>
        </div>
        <div style="flex:1">
          <h2 id="pmTitle" style="margin:0">Manage Plan</h2>
          <div class="sub" id="pmSubtitle">—</div>
        </div>
        <button class="btn ghost" id="closePlan" style="min-width:64px">Close</button>
      </div>

      <div class="m-body">
        <section class="card">
          <h3>Schedule & Settings</h3>
          <div class="row2" style="border:none"><div>Remaining</div><div id="pmRemaining"><b>$0.00</b></div></div>
          <div class="row2" style="border:none"><div>Next due</div><div id="pmNextDue">—</div></div>
          <div class="hr"></div>
          <div id="pmSchedule"></div>
        </section>

        <div style="display:flex;justify-content:center">
          <button class="btn" id="openPay">Make a payment</button>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="payModal">
    <div class="sheet dialog-anim" id="payAnim">
      <div class="m-head">
        <div style="flex:1">
          <h2 id="payTitle" style="margin:0">Make a Payment</h2>
          <div class="sub" id="paySubtitle">—</div>
        </div>
        <button class="btn ghost" id="closePay" style="min-width:64px">Close</button>
      </div>

      <div class="m-body">
        <section class="card">
          <h3>Make a Payment</h3>
          <div class="field">
            <label>Amount</label>
            <input id="payAmountInput" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" />
            <input id="payAmountRange" type="range" min="0" max="0" value="0" />
            <div class="hint">Drag the slider or enter a custom amount.</div>
          </div>

          <div class="field">
            <label>Speed</label>
            <div class="hint">Arrives <span id="payArrivalEta">instantly</span></div>
          </div>

          <div class="field">
            <label>Summary</label>
            <div class="row2" style="border:none"><div>Payment</div><div id="paySumPayment"><b>$0.00</b></div></div>
            <div class="row2" style="border:none"><div>Instant fee</div><div id="paySumFee">$0.00</div></div>
            <div class="hr"></div>
            <div class="row2" style="border:none"><div class="total">Total today</div><div id="paySumTotal" class="total">$0.00</div></div>
          </div>

          <div class="grid2">
            <button class="btn" id="payConfirm">Confirm & Pay</button>
          </div>
          <div class="hint">Demo only — no real money moves.</div>
        </section>
      </div>
    </div>
  </dialog>

  <!-- NEW PLAN: Step 1 (amount) -->
  <dialog id="npAmountModal">
    <div class="sheet dialog-anim" id="npAmountAnim">
      <div class="m-head">
        <div style="flex:1">
          <h2 style="margin:0">New Plan</h2>
          <div class="sub">Enter purchase amount</div>
        </div>
        <button class="btn ghost" id="npAmountClose" style="min-width:64px">Close</button>
      </div>
      <div class="m-body">
        <section class="card">
          <h3>Purchase amount</h3>
          <div class="field">
            <label>Amount</label>
            <input id="npAmountInput" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0.00" />
          </div>
          <button class="btn" id="npAmountNext">Next</button>
        </section>
      </div>
    </div>
  </dialog>

  <!-- NEW PLAN: Step 2 (choose type) -->
  <dialog id="npTypeModal">
    <div class="sheet dialog-anim" id="npTypeAnim">
      <div class="m-head">
        <div style="flex:1">
          <h2 style="margin:0">Choose plan</h2>
          <div class="sub">Select a loan type</div>
        </div>
        <button class="btn ghost" id="npTypeClose" style="min-width:64px">Close</button>
      </div>
      <div class="m-body">
        <section class="card" id="npOptions">
          <!-- options inserted by JS -->
        </section>
        <div style="display:flex;justify-content:center">
          <button class="btn" id="npTypeContinue" disabled>Continue</button>
        </div>
      </div>
    </div>
  </dialog>

<script>
(function(){
  const $ = (q, el=document)=> el.querySelector(q);
  const fmtMoney = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'});
  const fmtDate = (d)=> new Date(d).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});
  const addDays = (d, n)=> { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
  const addMonths = (d, n)=> { const x=new Date(d); const m=x.getMonth()+n; x.setMonth(m); return x; };
  const cap = (v,min,max)=> Math.max(min, Math.min(max, v));
  const EPS = 0.009;
  const LS_KEY = 'bnpl_mobile_demo_v2';

  let state = load() || seed();
  let currentPlan = null;

  function load(){ try { return JSON.parse(localStorage.getItem(LS_KEY)||''); } catch { return null; } }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function seed(){ return {plans:[], limit:1500, reserved:0, rewards:0}; }

  const els = {
    presentBalance: $('#presentBalance'), paydownBar: $('#paydownBar'), paydownSub: $('#paydownSub'),
    nextAmount: $('#nextAmount'), nextDate: $('#nextDate'), payNextBtn: $('#payNextBtn'),
    plansList: $('#plansList'), emptyState: $('#emptyState'), newPlan: $('#newPlan'),
  };

  function compute(){
    const presentBalance = state.plans.reduce((a,p)=> a + p.remaining, 0);
    const paid = state.plans.reduce((a,p)=> a + (p.total - p.remaining), 0);
    const total = state.plans.reduce((a,p)=> a + p.total, 0);
    const pct = total ? Math.round((paid/total)*100) : 0;
    const up = [];
    state.plans.forEach(p=>{
      const nxt = p.schedule.find(s=>!s.paid);
      if(nxt) up.push({plan:p, ...nxt});
    });
    up.sort((a,b)=> new Date(a.due)-new Date(b.due));
    const nextDue = up[0] || null;
    return {presentBalance, pct, nextDue};
  }

  function render(){
    const {presentBalance, pct, nextDue} = compute();
    els.presentBalance.textContent = fmtMoney.format(presentBalance);
    els.paydownBar.style.width = pct + '%';
    els.paydownSub.textContent = pct + '% paid';

    if(nextDue){
      els.nextAmount.textContent = fmtMoney.format(nextDue.amount);
      els.nextDate.textContent = fmtDate(nextDue.due);
      els.payNextBtn.disabled = false;
      els.payNextBtn.onclick = ()=> openPlanModal(nextDue.plan.id, nextDue.amount);
    }else{
      els.nextAmount.textContent = '$0.00';
      els.nextDate.textContent = '—';
      els.payNextBtn.disabled = true;
    }
    renderPlans();
  }

  function renderPlans(){
    const L = state.plans;
    $('#plansList').innerHTML = '';
    $('#emptyState').hidden = L.length>0;

    L.forEach(p=>{
      const next = p.schedule.find(s=>!s.paid);
      const paid = p.total - p.remaining;
      const pct = p.total? Math.round(paid/p.total*100):0;

      const row = document.createElement('div'); row.className = 'row';
      const left = document.createElement('div'); left.className='left';
      const logo = document.createElement('div'); logo.className='logo-sm'; logo.dataset.merchant = p.merchant[0].toUpperCase();
      logo.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="#cfe0ff"><circle cx="12" cy="12" r="8"/></svg>`;
      const ttl = document.createElement('div'); ttl.className='title';
      ttl.innerHTML = `<b>${p.merchant}</b>
        <div class="sub">Plan ${p.installments} • ${fmtMoney.format(p.total)}</div>
        <div style="margin-top:8px" class="progress" aria-label="Installment progress"><span style="width:${pct}%"></span></div>
        <div class="sub" style="margin-top:6px">${fmtMoney.format(Math.max(0, paid))} paid • ${pct}%</div>`;
      left.append(logo, ttl);

      const right = document.createElement('div'); right.className='right';
      const due = document.createElement('div');
      due.innerHTML = next ? `<span class="pill">Due ${fmtDate(next.due)}</span>` : `<span class="pill">Paid off</span>`;
      const manage = document.createElement('button'); manage.className='btn'; manage.textContent='Manage';
      manage.onclick = ()=> openPlanModal(p.id, next? next.amount : 0);
      right.append(due, manage);

      row.append(left, right);
      $('#plansList').append(row);
    });
  }

  /* ---------- Smooth dialog helpers ---------- */
  function openDialog(dlg, animEl){ if(dlg.showModal) dlg.showModal(); else dlg.setAttribute('open','open'); requestAnimationFrame(()=> animEl.classList.add('open')); }
  function closeDialog(dlg, animEl){
    animEl.classList.add('closing'); animEl.classList.remove('open');
    animEl.addEventListener('transitionend', function onEnd(){ animEl.removeEventListener('transitionend', onEnd); animEl.classList.remove('closing'); if(dlg.close) dlg.close(); else dlg.removeAttribute('open'); });
  }

  /* ---------- Plan modal (unchanged) ---------- */
  const planDlg = $('#planModal'), planAnim = $('#planAnim');
  const pl = { title: $('#pmTitle'), subtitle: $('#pmSubtitle'), logo: $('#pmLogo'), rem: $('#pmRemaining'), next: $('#pmNextDue'), sched: $('#pmSchedule'), openPay: $('#openPay'), close: $('#closePlan') };

  function openPlanModal(id, suggested=0){
    currentPlan = state.plans.find(p=>p.id===id); if(!currentPlan) return;
    pl.title.textContent = `${currentPlan.merchant} — Plan`;
    pl.subtitle.textContent = `${currentPlan.installments} installments • ${fmtMoney.format(currentPlan.total)}`;
    pl.logo.dataset.merchant = currentPlan.merchant[0].toUpperCase();
    pl.rem.innerHTML = `<b>${fmtMoney.format(currentPlan.remaining)}</b>`;
    const next = currentPlan.schedule.find(s=>!s.paid);
    pl.next.textContent = next? `${fmtDate(next.due)} • ${fmtMoney.format(next.amount)}` : 'Paid off';
    pl.sched.innerHTML = '';
    currentPlan.schedule.forEach(s=>{
      const r = document.createElement('div'); r.className='row2';
      r.innerHTML = `<div>#${s.idx} • ${fmtDate(s.due)} ${s.paid? '<span class="badge paid" style="margin-left:6px">Paid</span>' : ''}</div>
                     <div><b>${fmtMoney.format(s.amount)}</b></div>`;
      pl.sched.append(r);
    });
    pl.openPay.onclick = ()=> openPayModal(currentPlan.id, next? next.amount : 0);
    pl.close.onclick = ()=> closeDialog(planDlg, planAnim);
    openDialog(planDlg, planAnim);
  }

  /* ---------- Pay modal (unchanged behavior) ---------- */
  const payDlg = $('#payModal'), payAnim = $('#payAnim');
  const pay = { title: $('#payTitle'), subtitle: $('#paySubtitle'), range: $('#payAmountRange'), amount: $('#payAmountInput'), eta: $('#payArrivalEta'), sumPay: $('#paySumPayment'), sumFee: $('#paySumFee'), sumTotal: $('#paySumTotal'), confirm: $('#payConfirm'), close: $('#closePay') };

  function openPayModal(id, suggested=0){
    currentPlan = state.plans.find(p=>p.id===id); if(!currentPlan) return;
    pay.title.textContent = `Make a Payment`;
    pay.subtitle.textContent = `${currentPlan.merchant} • ${currentPlan.installments} installments • ${fmtMoney.format(currentPlan.total)}`;
    const max = +currentPlan.remaining.toFixed(2);
    pay.range.max = String(max);
    const start = suggested ? cap(suggested,0,max) : Math.min((currentPlan.schedule.find(s=>!s.paid)?.amount)||0, max);
    pay.range.value = String(start);
    pay.amount.value = (+pay.range.value || 0).toFixed(2);
    updatePaySummary();
    pay.close.onclick = ()=> closeDialog(payDlg, payAnim);
    openDialog(payDlg, payAnim);
  }
  function updatePaySummary(){
    const max = parseFloat(pay.range.max||'0');
    const val = cap(parseFloat(pay.amount.value||'0'), 0, max);
    pay.amount.value = isFinite(val) ? val.toFixed(2) : '0.00';
    pay.range.value = String(val);
    const fee = 0;
    const total = +(val + fee).toFixed(2);
    pay.sumPay.innerHTML = `<b>${fmtMoney.format(val)}</b>`;
    pay.sumFee.textContent = fmtMoney.format(fee);
    pay.sumTotal.textContent = fmtMoney.format(total);
    pay.eta.textContent = 'instantly';
  }
  pay.range.addEventListener('input', ()=>{ pay.amount.value = (+pay.range.value).toFixed(2); updatePaySummary(); });
  pay.amount.addEventListener('input', updatePaySummary);
  pay.confirm.addEventListener('click', ()=>{
    const val = parseFloat(pay.amount.value||'0'); if(!currentPlan || !val || val<=0) return;
    let remaining = val;
    for(const s of currentPlan.schedule){
      if(remaining<=0) break;
      if(s.paid) continue;
      const payAmt = Math.min(remaining, s.amount);
      s.amount = +(s.amount - payAmt).toFixed(2);
      remaining = +(remaining - payAmt).toFixed(2);
      if(s.amount <= EPS){ s.paid = true; s.paidAt = new Date().toISOString(); s.amount = 0; }
    }
    currentPlan.remaining = currentPlan.schedule.filter(s=>!s.paid).reduce((a,s)=> a + s.amount, 0);
    const paidOff = currentPlan.remaining <= EPS;
    if(paidOff){ state.plans = state.plans.filter(p => p.id !== currentPlan.id); currentPlan = null; }
    else { state.rewards = +((state.rewards||0) + Math.min(val*0.01, 1.50)).toFixed(2); }
    save(); render();
    closeDialog(payDlg, payAnim);
    if(paidOff){ closeDialog(planDlg, planAnim); } else { setTimeout(()=> openPlanModal(state.plans.find(p=>p.id)?.id || undefined), 180); }
  });

  /* ---------- New Plan flow (Amount -> Type) ---------- */
  const npAmountDlg = $('#npAmountModal'), npAmountAnim = $('#npAmountAnim');
  const npTypeDlg = $('#npTypeModal'), npTypeAnim = $('#npTypeAnim');
  const np = {
    amountInput: $('#npAmountInput'),
    amountNext: $('#npAmountNext'),
    amountClose: $('#npAmountClose'),
    typeClose: $('#npTypeClose'),
    optsContainer: $('#npOptions'),
    cont: $('#npTypeContinue')
  };
  let tempNew = { amount: 0, type: null };

  // Start flow
  $('#newPlan').addEventListener('click', ()=>{
    tempNew = { amount: 0, type: null };
    np.amountInput.value = '';
    openDialog(npAmountDlg, npAmountAnim);
  });
  np.amountClose.addEventListener('click', ()=> closeDialog(npAmountDlg, npAmountAnim));
  np.typeClose.addEventListener('click', ()=> closeDialog(npTypeDlg, npTypeAnim));

  np.amountNext.addEventListener('click', ()=>{
    const amt = parseFloat(np.amountInput.value || '0');
    if(!isFinite(amt) || amt <= 0){ alert('Enter a valid amount.'); return; }
    tempNew.amount = +(amt.toFixed(2));
    closeDialog(npAmountDlg, npAmountAnim);
    setTimeout(()=> openTypeStep(), 160); // smooth handoff
  });

  function openTypeStep(){
    // Build options dynamically
    np.optsContainer.innerHTML = '<h3>Options</h3>';
    const amount = tempNew.amount;
    const mkOpt = (id, title, line1, line2)=> {
      const b = document.createElement('button');
      b.type='button'; b.className='opt'; b.setAttribute('aria-pressed','false'); b.dataset.id=id;
      b.innerHTML = `<h4>${title}</h4><div>${line1}</div><small>${line2||''}</small>`;
      b.onclick = ()=>{
        tempNew.type = id;
        [...np.optsContainer.querySelectorAll('.opt')].forEach(x=>x.setAttribute('aria-pressed','false'));
        b.setAttribute('aria-pressed','true');
        np.cont.disabled = false;
      };
      np.optsContainer.append(b);
    };

    // 1) Bi-weekly for 6 weeks (4 payments incl. downpayment)
    const biPer = evenSplit(amount, 4)[0]; // display per 2 weeks
    mkOpt('biweekly', 'Bi-weekly • 6 weeks', `${fmtMoney.format(biPer)} every 2 weeks (4 payments)`, 'Downpayment required (first payment today). No interest.');

    // 2) 6 months (interest added after creation)
    const m6Per = (amount/6);
    mkOpt('6m', '6 months', `${fmtMoney.format(m6Per)} per month`, '25% interest is added after creating the plan.');

    // 3) 12 months (only if amount > $100)
    if(amount > 100){
      const m12Per = (amount/12);
      mkOpt('12m', '12 months', `${fmtMoney.format(m12Per)} per month`, '30% interest is added after creating the plan.');
    }

    np.cont.disabled = true;
    openDialog(npTypeDlg, npTypeAnim);
  }

  np.cont.addEventListener('click', ()=>{
    if(!tempNew.type) return;
    const today = new Date();
    let plan = null;

    if(tempNew.type === 'biweekly'){
      // 4 equal payments across 6 weeks, first due today (downpayment)
      const amounts = evenSplit(tempNew.amount, 4);
      const sched = [0,14,28,42].map((d, i)=>({
        idx:i+1, amount:+amounts[i].toFixed(2), due:addDays(today, d).toISOString(), paid:false, paidAt:null
      }));
      const total = round2(sum(amounts));
      plan = {id: nextId(), merchant:'Purchase', total, remaining: total, installments:4, schedule:sched, created: today.toISOString()};
    }

    if(tempNew.type === '6m'){
      // 25% interest added
      const total = round2(tempNew.amount * 1.25);
      const amounts = evenSplit(total, 6);
      const sched = Array.from({length:6}, (_,i)=>({idx:i+1, amount:+amounts[i].toFixed(2), due:addMonths(today, i+1).toISOString(), paid:false, paidAt:null}));
      plan = {id: nextId(), merchant:'Purchase', total, remaining: total, installments:6, schedule:sched, created: today.toISOString()};
    }

    if(tempNew.type === '12m'){
      // 30% interest added
      const total = round2(tempNew.amount * 1.30);
      const amounts = evenSplit(total, 12);
      const sched = Array.from({length:12}, (_,i)=>({idx:i+1, amount:+amounts[i].toFixed(2), due:addMonths(today, i+1).toISOString(), paid:false, paidAt:null}));
      plan = {id: nextId(), merchant:'Purchase', total, remaining: total, installments:12, schedule:sched, created: today.toISOString()};
    }

    if(plan){
      state.plans.push(plan); save(); render();
      closeDialog(npTypeDlg, npTypeAnim);
    }
  });

  /* Utils for splitting amounts */
  function round2(x){ return Math.round(x*100)/100; }
  function sum(arr){ return arr.reduce((a,b)=> a+b, 0); }
  function evenSplit(total, n){
    // Returns array of n numbers that sum to total with cents rounding
    const cents = Math.round(total*100);
    const base = Math.floor(cents / n);
    const rem = cents - base*n;
    const out = Array.from({length:n}, (_,i)=> (base + (i<rem?1:0)) / 100);
    return out;
  }
  function nextId(){ return (state.plans.reduce((mx,p)=> Math.max(mx,p.id),0)+1) || 1; }

  /* Pay next quick button */
  els.payNextBtn.addEventListener('click', ()=>{
    const up = compute().nextDue;
    if(up) openPlanModal(up.plan.id, up.amount);
  });

  render();
})();
</script>
</body>
</html>
